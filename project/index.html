<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบแจ้งส่งหนังสือเข้า</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.5/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .signature-pad {
      border: 1px solid #ccc;
      border-radius: 8px;
      width: 100%;
      height: 200px;
    }
  </style>
</head>
<body class="bg-gradient-to-r from-pink-300 via-purple-300 to-blue-300 min-h-screen font-sans">
  <div class="container mx-auto p-6">
    <h1 class="text-3xl font-bold text-center text-white mb-6">ระบบแจ้งส่งหนังสือเข้า</h1>
    <div class="text-white mb-4">
      <img id="userPicture" class="h-12 w-12 rounded-full inline-block mr-2 hidden" alt="User Profile">
      <span id="userName" class="hidden"></span>
    </div>

    <!-- Form -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <form id="bookForm" class="needs-validation space-y-4" novalidate>
        <div>
          <label for="bookNumber" class="block text-gray-700">เลขที่หนังสือ</label>
          <input type="text" id="bookNumber" class="form-control p-2 border rounded-lg" required>
          <div class="invalid-feedback">กรุณากรอกเลขที่หนังสือ</div>
        </div>
        <div>
          <label for="subject" class="block text-gray-700">เรื่องที่แจ้ง</label>
          <input type="text" id="subject" class="form-control p-2 border rounded-lg" required>
          <div class="invalid-feedback">กรุณากรอกเรื่องที่แจ้ง</div>
        </div>
        <div>
          <label for="activity" class="block text-gray-700">กิจกรรม</label>
          <select id="activity" class="form-select p-2 border rounded-lg" required>
            <option value="">เลือกกิจกรรม</option>
            <option value="ตอบปัญหา">ตอบปัญหา</option>
            <option value="เขียนตามคำบอก">เขียนตามคำบอก</option>
            <option value="เขียนเรียงความ">เขียนเรียงความ</option>
            <option value="คัดลายมือ">คัดลายมือ</option>
            <option value="โต้วาที">โต้วาที</option>
            <option value="ทำนองเสนาะ/เสภา">ทำนองเสนาะ/เสภา</option>
            <option value="แต่งคำประพันธ์">แต่งคำประพันธ์</option>
            <option value="โอ้เอ้วิหารราย">โอ้เอ้วิหารราย</option>
            <option value="อ่านออกเสียงร้อยแก้ว">อ่านออกเสียงร้อยแก้ว</option>
            <option value="พูดสุนทรพจน์">พูดสุนทรพจน์</option>
            <option value="เกมคำคมต่อคำศัพท์ภาษาไทย">เกมคำคมต่อคำศัพท์ภาษาไทย</option>
            <option value="พูดภาษาถิ่น">พูดภาษาถิ่น</option>
            <option value="ประกวดตัวละคร">ประกวดตัวละคร</option>
            <option value="หนังสือเล่มเล็ก">หนังสือเล่มเล็ก</option>
            <option value="สารานุกรม (ห้องสมุด)">สารานุกรม (ห้องสมุด)</option>
          </select>
          <div class="invalid-feedback">กรุณาเลือกกิจกรรม</div>
        </div>
        <div>
          <label for="teacher" class="block text-gray-700">มอบครูผู้รับผิดชอบ</label>
          <select id="teacher" class="form-select p-2 border rounded-lg" required>
            <option value="">เลือกครู</option>
            <option value="นางสาวอารี บัวคุ้มภัย">นางสาวอารี บัวคุ้มภัย</option>
            <option value="นายประยุทธ์ ไทรย้อยสกุลเลิศ">นายประยุทธ์ ไทรย้อยสกุลเลิศ</option>
            <option value="นายสุภัทรพงศ์ รวงผึ้งรุ่งโรจน์">นายสุภัทรพงศ์ รวงผึ้งรุ่งโรจน์</option>
            <option value="นางปนัศญา เจริญมาก">นางปนัศญา เจริญมาก</option>
            <option value="นางสาวสุวาณี ธรรมศรี">นางสาวสุวาณี ธรรมศรี</option>
            <option value="ว่าที่ร้อยตรีหญิงภาริษา ธนสิริงาม">ว่าที่ร้อยตรีหญิงภาริษา ธนสิริงาม</option>
            <option value="นางมณฑาทิพย์ คีรีสุทธิวงศ์">นางมณฑาทิพย์ คีรีสุทธิวงศ์</option>
            <option value="นางสาวสุปาณี อินองการ">นางสาวสุปาณี อินองการ</option>
            <option value="นางสาวนุชนาฏ แถลงสัตย์">นางสาวนุชนาฏ แถลงสัตย์</option>
            <option value="ว่าที่ร้อยตรีหญิงอุบลวรรณ กันตะแก้ว">ว่าที่ร้อยตรีหญิงอุบลวรรณ กันตะแก้ว</option>
            <option value="นายณัฐพล เนียมพิทักษ์">นายณัฐพล เนียมพิทักษ์</option>
            <option value="นายสัมฤทธิ์ มีทรัพย์มั่น">นายสัมฤทธิ์ มีทรัพย์มั่น</option>
            <option value="นางสาวเพชรนภา ผาดผ่อง">นางสาวเพชรนภา ผาดผ่อง</option>
            <option value="นางสาวมัทวัน ศรีภักดี">นางสาวมัทวัน ศรีภักดี</option>
            <option value="นายสรนันท์ สายดี">นายสรนันท์ สายดี</option>
          </select>
          <div class="invalid-feedback">กรุณาเลือกครูผู้รับผิดชอบ</div>
        </div>
        <div>
          <label for="fileUpload" class="block text-gray-700">อัพโหลดไฟล์</label>
          <input type="file" id="fileUpload" class="form-control p-2 border rounded-lg">
          <div class="invalid-feedback">กรุณาอัพโหลดไฟล์</div>
        </div>
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">บันทึก</button>
      </form>
    </div>

    <!-- Chart -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4">จำนวนกิจกรรม</h2>
      <canvas id="activityChart"></canvas>
    </div>

    <!-- Recent Records Table -->
    <div class="bg-white rounded-lg shadow-lg p-6">
      <h2 class="text-xl font-semibold mb-4">ข้อมูลล่าสุด</h2>
      <table class="w-full text-left table table-striped">
        <thead>
          <tr class="bg-gray-100">
            <th class="p-2">เลขที่หนังสือ</th>
            <th class="p-2">กิจกรรม</th>
            <th class="p-2">ครูผู้รับผิดชอบ</th>
            <th class="p-2">ลายเซ็น</th>
            <th class="p-2">การกระทำ</th>
          </tr>
        </thead>
        <tbody id="recentRecords"></tbody>
      </table>
    </div>
  </div>

  <!-- Signature Modal -->
  <div id="signatureModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 w-full max-w-md">
      <h2 class="text-xl font-semibold mb-4">ลงลายเซ็นรับทราบ</h2>
      <canvas id="signaturePad" class="signature-pad"></canvas>
      <div class="flex justify-end mt-4 space-x-2">
        <button id="clearSignature" class="bg-gray-500 text-white px-4 py-2 rounded-lg">ล้าง</button>
        <button id="saveSignature" class="bg-blue-500 text-white px-4 py-2 rounded-lg">บันทึก</button>
      </div>
    </div>
  </div>

  <script>
    const scriptUrl = 'https://script.google.com/macros/s/AKfycbzHrM4TXg-Ot2P1da3Jq6J5b6W7Ukn2jLr_0Mql8XvfY-XXm9G1_H2HUFIlTrqkSzgc/exec';
    const LIFF_ID = '2005780370-27LZkWna';
    const botBasicId = '@233svlmc';
    let signaturePad;
    let currentRecordId;
    let userId, userName, userPicture;

    // Initialize LIFF
    $(document).ready(() => {
      $.LoadingOverlay('show');
      liff.init({
        liffId: LIFF_ID,
        withLoginOnExternalBrowser: true
      }).then(() => {
        liff.ready.then(async () => {
          console.log('LIFF Working!');
          try {
            if (liff.isLoggedIn()) {
              const profile = await liff.getProfile();
              userId = profile.userId;
              userName = profile.displayName;
              userPicture = profile.pictureUrl;

              $('#userName').text(userName);
              $('#userPicture').attr('src', userPicture);
              $('#userName').removeClass('hidden');
              $('#userPicture').removeClass('hidden');

              const friendship = await liff.getFriendship();
              if (!friendship.friendFlag) {
                Swal.fire({
                  icon: 'error',
                  title: 'เดี๋ยวก่อน!',
                  text: 'คุณยังไม่ได้เป็นเพื่อนกับเรา',
                  allowOutsideClick: false,
                  confirmButtonText: 'ตกลง'
                }).then(() => {
                  window.location = 'https://line.me/R/ti/p/' + botBasicId;
                  $.LoadingOverlay('hide');
                });
                return;
              }
              await loadData();
            } else {
              liff.login({ redirectUri: window.location.href });
              $.LoadingOverlay('hide');
            }
          } catch (error) {
            console.error('LIFF initialization failed:', error);
            Swal.fire({
              toast: true,
              position: 'top-end',
              icon: 'info',
              title: 'ไม่สามารถเชื่อมต่อกับ LINE ได้ (กำลังใช้โหมดทดสอบ)',
              showConfirmButton: false,
              timer: 3000
            });
            $.LoadingOverlay('hide');
          }
        });
      }).catch(error => {
        console.error('LIFF init failed:', error);
        Swal.fire({
          toast: true,
          position: 'top-end',
          icon: 'error',
          title: 'เกิดข้อผิดพลาดในการเริ่มต้น LIFF: ' + error.message,
          showConfirmButton: false,
          timer: 5000
        });
        $.LoadingOverlay('hide');
      });
    });

    // Form Submission
    function submit() {
      $.LoadingOverlay('show');
      console.log('ฟังก์ชั่น submit ทำงาน');

      const fileInput = $('#fileUpload')[0];
      let data = {
        opt: 'savedata',
        uid: liff.getDecodedIDToken()?.sub || userId,
        name: userName,
        bookNumber: $('#bookNumber').val(),
        subject: $('#subject').val(),
        activity: $('#activity').val(),
        teacher: $('#teacher').val(),
        fileimage: '',
        filetype: '',
        filename: ''
      };

      new Promise((resolve, reject) => {
        if (fileInput.files.length > 0) {
          const file = fileInput.files[0];
          data.filetype = file.type;
          data.filename = file.name;
          readFileAsBase64(file).then(fileData => {
            data.fileimage = fileData;
            resolve(data);
          }).catch(error => {
            console.error('File read error:', error);
            reject(error);
          });
        } else {
          resolve(data);
        }
      }).then(data => {
        console.log('Submitting data:', data);
        $.ajax({
          method: 'POST',
          url: scriptUrl,
          data: data,
          dataType: 'json',
          crossDomain: true,
          success: function (res) {
            $.LoadingOverlay('hide');
            console.log('Submission success:', res);
            if (res.status === 'success') {
              $('#bookForm')[0].reset();
              Swal.fire({
                icon: 'success',
                title: 'บันทึกข้อมูลเรียบร้อย',
                text: `ID: ${res.id}`,
                allowOutsideClick: false,
                confirmButtonText: 'ตกลง'
              }).then(() => {
                confetti({
                  particleCount: 100,
                  spread: 70,
                  origin: { y: 0.6 }
                });

                // Share via ShareTargetPicker
                const flexMessage = {
                  type: 'flex',
                  altText: 'แจ้งส่งหนังสือเข้า',
                  contents: {
                    type: 'bubble',
                    body: {
                      type: 'box',
                      layout: 'vertical',
                      contents: [
                        { type: 'text', text: 'แจ้งส่งหนังสือเข้า', weight: 'bold', size: 'xl' },
                        { type: 'text', text: `เลขที่: ${data.bookNumber}` },
                        { type: 'text', text: `เรื่อง: ${data.subject}` },
                        { type: 'text', text: `กิจกรรม: ${data.activity}` },
                        { type: 'text', text: `ครู: ${data.teacher}` },
                        { type: 'text', text: `ผู้บันทึก: ${data.name}` }
                      ]
                    }
                  }
                };
                liff.shareTargetPicker([{ type: 'flex', altText: 'แจ้งส่งหนังสือเข้า', contents: flexMessage.contents }])
                  .then(() => {
                    Swal.fire({
                      toast: true,
                      position: 'top-end',
                      icon: 'success',
                      title: 'ส่งข้อความเรียบร้อย!',
                      showConfirmButton: false,
                      timer: 3000
                    });
                  })
                  .catch(error => {
                    console.error('ShareTargetPicker failed:', error);
                    Swal.fire({
                      toast: true,
                      position: 'top-end',
                      icon: 'error',
                      title: 'ส่งข้อความล้มเหลว: ' + error.message,
                      showConfirmButton: false,
                      timer: 5000
                    });
                  });
                loadData();
              });
            } else {
              Swal.fire({
                icon: 'error',
                title: 'เกิดข้อผิดพลาด',
                text: res.error || 'ไม่ทราบสาเหตุ',
                allowOutsideClick: false,
                confirmButtonText: 'ตกลง'
              });
            }
          },
          error: function (jqXHR, textStatus, errorThrown) {
            $.LoadingOverlay('hide');
            console.error('Form submission failed:', textStatus, errorThrown, jqXHR);
            Swal.fire({
              icon: 'error',
              title: 'บันทึกข้อมูลไม่สำเร็จ',
              text: `ข้อผิดพลาด: ${textStatus} (${errorThrown})`,
              allowOutsideClick: false,
              confirmButtonText: 'ตกลง'
            });
            // Fallback fetch
            fetch(scriptUrl, {
              method: 'POST',
              body: new URLSearchParams(data),
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
            }).then(response => response.json())
              .then(result => console.log('Fetch fallback success:', result))
              .catch(err => console.error('Fetch fallback failed:', err));
          }
        });
      }).catch(error => {
        $.LoadingOverlay('hide');
        console.error('Submission error:', error);
        Swal.fire({
          icon: 'error',
          title: 'บันทึกข้อมูลไม่สำเร็จ',
          text: 'ข้อผิดพลาด: ' + error.message,
          allowOutsideClick: false,
          confirmButtonText: 'ตกลง'
        });
      });
    }

    // Form Validation
    (() => {
      'use strict';
      const forms = document.querySelectorAll('.needs-validation');
      Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
          event.preventDefault();
          if (!form.checkValidity()) {
            event.stopPropagation();
            form.classList.add('was-validated');
            $('#bookForm').find(':invalid').first().focus();
          } else {
            submit();
          }
        }, false);
      });
    })();

    // Read file as base64
    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Load Data
    async function loadData() {
      $.LoadingOverlay('show');
      Swal.fire({
        toast: true,
        position: 'top-end',
        icon: 'info',
        title: 'กำลังโหลดข้อมูล...',
        showConfirmButton: false,
        timer: 3000
      });

      try {
        const response = await fetch(`${scriptUrl}?action=get`, {
          method: 'GET'
        });
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const data = await response.json();

        // Update Table
        const tbody = $('#recentRecords');
        tbody.empty();
        data.slice(-5).reverse().forEach(record => {
          const tr = $(`
            <tr>
              <td class="p-2">${record.bookNumber}</td>
              <td class="p-2">${record.activity}</td>
              <td class="p-2">${record.teacher}</td>
              <td class="p-2">${record.signature ? `<img src="${record.signature}" class="h-12" alt="Signature">` : ''}</td>
              <td class="p-2">
                <button onclick="viewDetails('${record.id}')" class="bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600">ดู</button>
                ${!record.signature ? `<button onclick="openSignatureModal('${record.id}')" class="bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">รับทราบ</button>` : ''}
              </td>
            </tr>
          `);
          tbody.append(tr);
        });

        // Update Chart
        const activityCounts = {};
        data.forEach(record => {
          activityCounts[record.activity] = (activityCounts[record.activity] || 0) + 1;
        });

        const ctx = document.getElementById('activityChart').getContext('2d');
        if (window.activityChart) window.activityChart.destroy();
        window.activityChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: Object.keys(activityCounts),
            datasets: [{
              label: 'จำนวนกิจกรรม',
              data: Object.values(activityCounts),
              backgroundColor: [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEEAD',
                '#D4A5A5', '#9B59B6', '#3498DB', '#E74C3C', '#2ECC71'
              ]
            }]
          },
          options: {
            scales: {
              y: { beginAtZero: true }
            }
          }
        });
      } catch (error) {
        console.error('Data loading failed:', error);
        Swal.fire({
          toast: true,
          position: 'top-end',
          icon: 'error',
          title: 'โหลดข้อมูลล้มเหลว: ' + error.message,
          showConfirmButton: false,
          timer: 5000
        });
      } finally {
        $.LoadingOverlay('hide');
      }
    }

    // View Details
    function viewDetails(id) {
      Swal.fire({
        title: 'รายละเอียด',
        html: 'กำลังโหลด...',
        didOpen: async () => {
          try {
            const response = await fetch(`${scriptUrl}?action=getById&id=${id}`);
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }
            const record = await response.json();
            Swal.fire({
              title: 'รายละเอียด',
              html: `
                <p><strong>เลขที่หนังสือ:</strong> ${record.bookNumber}</p>
                <p><strong>เรื่อง:</strong> ${record.subject}</p>
                <p><strong>กิจกรรม:</strong> ${record.activity}</p>
                <p><strong>ครู:</strong> ${record.teacher}</p>
                ${record.file ? `<p><a href="${record.file}" target="_blank">ดูไฟล์</a></p>` : ''}
                ${record.signature ? `<p><img src="${record.signature}" class="h-24" alt="Signature"></p>` : ''}
                <p><strong>ผู้บันทึก:</strong> ${record.userName || 'ไม่ระบุ'}</p>
              `,
              allowOutsideClick: false,
              confirmButtonText: 'ตกลง'
            });
          } catch (error) {
            console.error('View details failed:', error);
            Swal.fire({
              icon: 'error',
              title: 'เกิดข้อผิดพลาด',
              text: 'ไม่สามารถโหลดข้อมูลได้: ' + error.message,
              allowOutsideClick: false,
              confirmButtonText: 'ตกลง'
            });
          }
        }
      });
    }

    // Signature Modal
    function openSignatureModal(id) {
      currentRecordId = id;
      const modal = $('#signatureModal');
      const canvas = $('#signaturePad')[0];
      modal.removeClass('hidden');
      signaturePad = new SignaturePad(canvas, {
        backgroundColor: 'rgb(255, 255, 255)'
      });
    }

    $('#clearSignature').on('click', () => {
      signaturePad.clear();
    });

    $('#saveSignature').on('click', async () => {
      if (signaturePad.isEmpty()) {
        Swal.fire({
          toast: true,
          position: 'top-end',
          icon: 'warning',
          title: 'กรุณาลงลายเซ็น',
          showConfirmButton: false,
          timer: 3000
        });
        return;
      }

      $.LoadingOverlay('show');
      Swal.fire({
        toast: true,
        position: 'top-end',
        icon: 'info',
        title: 'กำลังบันทึกลายเซ็น...',
        showConfirmButton: false,
        timer: 3000
      });

      try {
        const signatureData = signaturePad.toDataURL('image/png').split(',')[1];
        const response = await $.ajax({
          method: 'POST',
          url: scriptUrl,
          data: {
            opt: 'addSignature',
            id: currentRecordId,
            signature: signatureData
          },
          dataType: 'json',
          crossDomain: true
        });

        if (response.status === 'success') {
          Swal.fire({
            icon: 'success',
            title: 'บันทึกลายเซ็นเรียบร้อย',
            allowOutsideClick: false,
            confirmButtonText: 'ตกลง'
          });
          confetti({
            particleCount: 100,
            spread: 70,
            origin: { y: 0.6 }
          });
          $('#signatureModal').addClass('hidden');
          signaturePad.clear();
          await loadData();
        } else {
          Swal.fire({
            icon: 'error',
            title: 'บันทึกลายเซ็นล้มเหลว',
            text: response.error || 'ไม่ทราบสาเหตุ',
            allowOutsideClick: false,
            confirmButtonText: 'ตกลง'
          });
        }
      } catch (error) {
        console.error('Signature saving failed:', error);
        Swal.fire({
          icon: 'error',
          title: 'เกิดข้อผิดพลาดในการบันทึกลายเซ็น',
          text: error.message,
          allowOutsideClick: false,
          confirmButtonText: 'ตกลง'
        });
        // Fallback fetch
        fetch(scriptUrl, {
          method: 'POST',
          body: new URLSearchParams({
            opt: 'addSignature',
            id: currentRecordId,
            signature: signatureData
          }),
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
        }).then(response => response.json())
          .then(result => console.log('Signature fetch fallback success:', result))
          .catch(err => console.error('Signature fetch fallback failed:', err));
      } finally {
        $.LoadingOverlay('hide');
      }
    });
  </script>
</body>
</html>
