// code.gs
// Google Apps Script for handling insert/get/update operations on Google Sheet
// and uploading files to Google Drive.

const SPREADSHEET_ID = '1Ac9rY4r8uiObyzv259gNojZFaIZl5RswsBWtnWkiFSw';
const SHEET_NAME = 'Deliveries';
const FOLDER_ID = '1AjKaXdXrzF7OTq0tUTLlSpfHxWoUgCB0';

// Headers in Sheet: A: id, B: no, C: topic, D: activity, E: teacher, F: fileurl, G: signature

function doGet(e) {
  Logger.log('doGet called with params: ' + JSON.stringify(e.parameter));
  try {
    const params = e.parameter;
    const action = params.action;

    if (action === 'getHistory') {
      return getHistory();
    }
    return jsonOutput({ success: false, message: 'Invalid action' });
  } catch (error) {
    Logger.log('Error in doGet: ' + error.message);
    return jsonOutput({ success: false, message: `Error in doGet: ${error.message}` });
  }
}

function doPost(e) {
  Logger.log('doPost called with data: ' + e.postData.contents);
  try {
    if (!e.postData || e.postData.type !== 'application/json') {
      return jsonOutput({ success: false, message: 'Unsupported content type, expected application/json' });
    }

    let body;
    try {
      body = JSON.parse(e.postData.contents);
    } catch (err) {
      Logger.log('Invalid JSON body: ' + err.message);
      return jsonOutput({ success: false, message: `Invalid JSON body: ${err.message}` });
    }

    const action = body.action;

    if (action === 'insert') {
      const no = body.no;
      const topic = body.topic;
      const activity = body.activity;
      const teacher = body.teacher;
      const fileBase64 = body.fileBase64;
      const fileName = body.fileName;
      const mimeType = body.mimeType;

      if (!no || !topic || !activity || !teacher) {
        return jsonOutput({ success: false, message: 'Missing required fields' });
      }

      let fileurl = '';
      if (fileBase64 && fileName && mimeType) {
        try {
          const data = Utilities.base64Decode(fileBase64);
          const blob = Utilities.newBlob(data, mimeType, fileName);
          const folder = DriveApp.getFolderById(FOLDER_ID || 'root');
          const file = folder.createFile(blob);
          file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
          fileurl = file.getUrl();
        } catch (err) {
          Logger.log('File upload failed: ' + err.message);
          return jsonOutput({ success: false, message: `File upload failed: ${err.message}` });
        }
      }

      const id = new Date().getTime().toString();
      const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
      sheet.appendRow([id, no, topic, activity, teacher, fileurl, '']);

      return jsonOutput({
        success: true,
        data: { id, no, topic, activity, teacher, fileurl }
      });
    } else if (action === 'updateSignature') {
      const id = body.id;
      const sig = body.sig;

      if (!id || !sig) {
        return jsonOutput({ success: false, message: 'Missing id or sig' });
      }

      try {
        const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
        const data = sheet.getDataRange().getValues();

        for (let i = 1; i < data.length; i++) {
          if (data[i][0] == id) {
            sheet.getRange(i + 1, 7).setValue(sig);
            Logger.log('Signature updated for ID: ' + id);
            return jsonOutput({ success: true });
          }
        }
        Logger.log('ID not found: ' + id);
        return jsonOutput({ success: false, message: 'ID not found' });
      } catch (error) {
        Logger.log('Error in updateSignature: ' + error.message);
        return jsonOutput({ success: false, message: `Error in updateSignature: ${error.message}` });
      }
    }

    return jsonOutput({ success: false, message: 'Invalid action' });
  } catch (error) {
    Logger.log('Error in doPost: ' + error.message);
    return jsonOutput({ success: false, message: `Error in doPost: ${error.message}` });
  }
}

function getHistory() {
  try {
    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
    const data = sheet.getDataRange().getValues();
    const headers = data[0].map(h => h.toLowerCase());
    const rows = data.slice(1).map(row => {
      const obj = {};
      headers.forEach((h, i) => {
        obj[h] = row[i];
      });
      return obj;
    });
    Logger.log('getHistory returning ' + rows.length + ' rows');
    return jsonOutput(rows);
  } catch (error) {
    Logger.log('Error in getHistory: ' + error.message);
    return jsonOutput({ success: false, message: `Error in getHistory: ${error.message}` });
  }
}

function jsonOutput(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

function doOptions(e) {
  Logger.log('doOptions called');
  return jsonOutput({ success: true });
}
