<!DOCTYPE html>
<html lang="th">
<head>
    <!-- ... (คงเดิมทั้งหมดจากโค้ดก่อนหน้า) ... -->
</head>
<body class="bg-gray-50">
    <!-- ... (HTML คงเดิมทั้งหมด) ... -->

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzHrM4TXg-Ot2P1da3Jq6J5b6W7Ukn2jLr_0Mql8XvfY-XXm9G1_H2HUFIlTrqkSzgc/exec';

        // Retry function for fetch
        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000);
                    const response = await fetch(url, { ...options, signal: controller.signal });
                    clearTimeout(timeoutId);
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText || 'Unknown error'}`);
                    }
                    return await response.json();
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // Preloader
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                document.getElementById('preloader').style.display = 'none';
            }, 1500);
            initializeApp();
        });

        function initializeApp() {
            initTabs();
            fetchRecentData();
            fetchAllData();
            initCharts();
            initFormSubmission();
            initFileUpload();
            initSignaturePad();
            initModals();
            initSearchAndFilter();
        }

        function initTabs() {
            const tabs = ['form', 'data', 'stats'];
            const tabButtons = tabs.map(tab => document.getElementById(`tab-${tab}`));
            const sections = tabs.map(tab => document.getElementById(`section-${tab}`));
            
            tabButtons.forEach((button, index) => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => {
                        btn.classList.remove('tab-active');
                        btn.classList.add('text-gray-600');
                    });
                    button.classList.add('tab-active');
                    button.classList.remove('text-gray-600');
                    
                    sections.forEach(section => section.classList.add('hidden'));
                    sections[index].classList.remove('hidden');
                });
            });
            
            document.getElementById('view-all-btn').addEventListener('click', () => {
                tabButtons[0].classList.remove('tab-active');
                tabButtons[0].classList.add('text-gray-600');
                tabButtons[1].classList.add('tab-active');
                tabButtons[1].classList.remove('text-gray-600');
                
                sections[0].classList.add('hidden');
                sections[1].classList.remove('hidden');
            });
        }

        async function fetchRecentData() {
            try {
                const data = await fetchWithRetry(`${GAS_URL}?action=getRecent`, { method: 'GET' });
                renderTableData('recent-data', data, false);
            } catch (error) {
                console.error('Fetch recent data error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: `ไม่สามารถโหลดข้อมูลล่าสุดได้: ${error.message}`,
                    confirmButtonText: 'ตกลง'
                });
            }
        }

        async function fetchAllData(activityFilter = '', searchTerm = '') {
            try {
                const params = new URLSearchParams({ action: 'getAll', activity: activityFilter, search: searchTerm });
                const data = await fetchWithRetry(`${GAS_URL}?${params}`, { method: 'GET' });
                renderTableData('all-data', data, true);
            } catch (error) {
                console.error('Fetch all data error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: `ไม่สามารถโหลดข้อมูลทั้งหมดได้: ${error.message}`,
                    confirmButtonText: 'ตกลง'
                });
            }
        }

        async function fetchStats() {
            try {
                const data = await fetchWithRetry(`${GAS_URL}?action=getStats`, { method: 'GET' });
                return data;
            } catch (error) {
                console.error('Fetch stats error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: `ไม่สามารถโหลดสถิติได้: ${error.message}`,
                    confirmButtonText: 'ตกลง'
                });
                return { activityStats: {}, responsibleStats: {} };
            }
        }

        function renderTableData(containerId, data, includeActions = false) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if (!data || data.length === 0) {
                container.innerHTML = `<tr><td colspan="${includeActions ? 7 : 6}" class="px-6 py-4 text-center text-sm text-gray-500">ไม่พบข้อมูล</td></tr>`;
                return;
            }
            data.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.dataset.id = item.id;
                const formattedDate = formatDate(item.date);
                let html = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formattedDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.docNumber}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${item.subject}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${item.activity}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${item.responsible}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${getStatusBadge(item.status, item.signature)}</td>
                `;
                if (includeActions) {
                    html += `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right">
                            <button class="view-details text-blue-600 hover:text-blue-800 mr-3">รายละเอียด</button>
                            ${item.status === 'รอการรับทราบ' ? `<button class="acknowledge-btn bg-green-600 text-white px-3 py-1 rounded-lg hover:bg-green-700">รับทราบ</button>` : `<button class="view-signature text-gray-600 hover:text-gray-800">ดูลายเซ็น</button>`}
                        </td>
                    `;
                }
                row.innerHTML = html;
                container.appendChild(row);
            });
            container.querySelectorAll('.view-details').forEach(btn => btn.addEventListener('click', (e) => showDetailModal(e.target.closest('tr').dataset.id)));
            container.querySelectorAll('.acknowledge-btn').forEach(btn => btn.addEventListener('click', (e) => showSignatureModal(e.target.closest('tr').dataset.id)));
            container.querySelectorAll('.view-signature').forEach(btn => btn.addEventListener('click', (e) => showSignatureView(e.target.closest('tr').dataset.id)));
        }

        async function initCharts() {
            const stats = await fetchStats();
            const activityCtx = document.getElementById('activity-chart').getContext('2d');
            new Chart(activityCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(stats.activityStats || {}),
                    datasets: [{
                        label: 'จำนวนกิจกรรม',
                        data: Object.values(stats.activityStats || {}),
                        backgroundColor: 'rgba(56, 182, 255, 0.7)',
                        borderColor: 'rgba(56, 182, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
                    plugins: { legend: { display: false }, title: { display: true, text: 'จำนวนกิจกรรมแยกตามประเภท', font: { size: 16 } } }
                }
            });
            const responsibleCtx = document.getElementById('responsible-chart').getContext('2d');
            new Chart(responsibleCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(stats.responsibleStats || {}),
                    datasets: [{
                        data: Object.values(stats.responsibleStats || {}),
                        backgroundColor: ['rgba(255, 87, 87, 0.7)', 'rgba(82, 113, 255, 0.7)', 'rgba(56, 182, 255, 0.7)', 'rgba(255, 250, 221, 0.7)', 'rgba(255, 159, 67, 0.7)', 'rgba(46, 213, 115, 0.7)', 'rgba(155, 89, 182, 0.7)'],
                        borderColor: ['rgba(255, 87, 87, 1)', 'rgba(82, 113, 255, 1)', 'rgba(56, 182, 255, 1)', 'rgba(255, 250, 221, 1)', 'rgba(255, 159, 67, 1)', 'rgba(46, 213, 115, 1)', 'rgba(155, 89, 182, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { boxWidth: 15, font: { size: 11 } } }, title: { display: true, text: 'จำนวนกิจกรรมแยกตามผู้รับผิดชอบ', font: { size: 16 } } }
                }
            });
        }

        function initFormSubmission() {
            const form = document.getElementById('document-form');
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                const fileInput = document.getElementById('file-upload');
                if (fileInput.files[0] && fileInput.files[0].size > 10 * 1024 * 1024) {
                    Swal.fire({
                        icon: 'error',
                        title: 'ไฟล์ใหญ่เกินไป',
                        text: 'กรุณาอัพโหลดไฟล์ที่มีขนาดไม่เกิน 10MB',
                        confirmButtonText: 'ตกลง'
                    });
                    return;
                }
                const formData = new FormData();
                formData.append('action', 'saveDocument');
                formData.append('date', new Date().toISOString().split('T')[0]);
                formData.append('docNumber', document.getElementById('doc-number').value);
                formData.append('subject', document.getElementById('doc-subject').value);
                formData.append('activity', document.getElementById('activity').value);
                formData.append('responsible', document.getElementById('responsible').value);
                if (fileInput.files[0]) {
                    formData.append('file', fileInput.files[0]);
                }
                try {
                    const response = await fetchWithRetry(GAS_URL, {
                        method: 'POST',
                        body: formData
                    });
                    if (response.status === 'success') {
                        Swal.fire({
                            icon: 'success',
                            title: 'บันทึกข้อมูลสำเร็จ',
                            text: 'ข้อมูลหนังสือถูกบันทึกเรียบร้อยแล้ว',
                            confirmButtonText: 'ตกลง'
                        }).then(() => {
                            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                        });
                        fetchRecentData();
                        fetchAllData();
                        form.reset();
                        document.getElementById('file-name').textContent = '';
                    } else {
                        throw new Error(response.message || 'Failed to save document');
                    }
                } catch (error) {
                    console.error('Save document error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: `ไม่สามารถบันทึกข้อมูลได้: ${error.message}`,
                        confirmButtonText: 'ตกลง'
                    });
                }
            });
        }

        function initFileUpload() {
            const fileUpload = document.getElementById('file-upload');
            const fileName = document.getElementById('file-name');
            fileUpload.addEventListener('change', function() {
                fileName.textContent = this.files[0] ? this.files[0].name : '';
            });
        }

        let signaturePad;
        function initSignaturePad() {
            const canvas = document.getElementById('signature-pad');
            signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(255, 255, 255)', penColor: 'rgb(0, 0, 0)' });
            document.getElementById('clear-signature').addEventListener('click', () => signaturePad.clear());
            document.getElementById('save-signature').addEventListener('click', async () => {
                if (signaturePad.isEmpty()) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'ลายเซ็นว่างเปล่า',
                        text: 'กรุณาลงลายมือชื่อก่อนบันทึก',
                        confirmButtonText: 'ตกลง'
                    });
                    return;
                }
                const signatureData = signaturePad.toDataURL();
                const documentId = document.getElementById('document-id').value;
                try {
                    const response = await fetchWithRetry(GAS_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'saveSignature', id: documentId, signature: signatureData }),
                        headers: { 'Content-Type': 'application/json' }
                    });
                    if (response.status === 'success') {
                        Swal.fire({
                            icon: 'success',
                            title: 'บันทึกลายเซ็นสำเร็จ',
                            text: 'ลายเซ็นถูกบันทึกเรียบร้อยแล้ว',
                            confirmButtonText: 'ตกลง'
                        }).then(() => {
                            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                        });
                        document.getElementById('signature-modal').style.display = 'none';
                        fetchRecentData();
                        fetchAllData();
                    } else {
                        throw new Error(response.message || 'Failed to save signature');
                    }
                } catch (error) {
                    console.error('Save signature error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: `ไม่สามารถบันทึกลายเซ็นได้: ${error.message}`,
                        confirmButtonText: 'ตกลง'
                    });
                }
            });
        }

        function initModals() {
            document.getElementById('close-detail-modal').addEventListener('click', () => document.getElementById('detail-modal').style.display = 'none');
            document.getElementById('close-detail-btn').addEventListener('click', () => document.getElementById('detail-modal').style.display = 'none');
            document.getElementById('close-signature-modal').addEventListener('click', () => document.getElementById('signature-modal').style.display = 'none');
            window.addEventListener('click', (event) => {
                if (event.target === document.getElementById('detail-modal')) document.getElementById('detail-modal').style.display = 'none';
                if (event.target === document.getElementById('signature-modal')) document.getElementById('signature-modal').style.display = 'none';
            });
        }

        async function showDetailModal(id) {
            try {
                const data = await fetchWithRetry(`${GAS_URL}?action=getDetail&id=${id}`, { method: 'GET' });
                const detailContent = document.getElementById('detail-content');
                const formattedDate = formatDate(data.date);
                detailContent.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><p class="text-sm font-medium text-gray-500">วันที่</p><p class="text-lg">${formattedDate}</p></div>
                        <div><p class="text-sm font-medium text-gray-500">เลขที่หนังสือ</p><p class="text-lg">${data.docNumber}</p></div>
                    </div>
                    <div><p class="text-sm font-medium text-gray-500">เรื่อง</p><p class="text-lg">${data.subject}</p></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><p class="text-sm font-medium text-gray-500">กิจกรรม</p><p class="text-lg">${data.activity}</p></div>
                        <div><p class="text-sm font-medium text-gray-500">ผู้รับผิดชอบ</p><p class="text-lg">${data.responsible}</p></div>
                    </div>
                    <div><p class="text-sm font-medium text-gray-500">สถานะ</p><p class="text-lg">${data.status}</p></div>
                    ${data.signature ? `<div><p class="text-sm font-medium text-gray-500">ลายเซ็นรับทราบ</p><img src="${data.signature}" alt="ลายเซ็น" class="mt-2 border border-gray-300 rounded-lg" style="max-height: 100px;"></div>` : ''}
                    ${data.fileLink ? `<div><p class="text-sm font-medium text-gray-500">ไฟล์แนบ</p><a href="${data.fileLink}" target="_blank" class="text-blue-600 hover:text-blue-800 flex items-center mt-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a3 3 0 00-3 3v4a5 5 0 0010 0V7a1 1 0 112 0v4a7 7 0 11-14 0V7a5 5 0 0110 0v4a3 3 0 11-6 0V7a1 1 0 012 0v4a1 1 0 102 0V7a3 3 0 00-3-3z" clip-rule="evenodd" /></svg>ดูไฟล์แนบ</a></div>` : ''}
                `;
                document.getElementById('detail-modal').style.display = 'flex';
            } catch (error) {
                console.error('Show detail error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: `ไม่สามารถโหลดรายละเอียดได้: ${error.message}`,
                    confirmButtonText: 'ตกลง'
                });
            }
        }

        async function showSignatureView(id) {
            try {
                const data = await fetchWithRetry(`${GAS_URL}?action=getDetail&id=${id}`, { method: 'GET' });
                if (data.signature) {
                    Swal.fire({
                        title: 'ลายเซ็นรับทราบ',
                        imageUrl: data.signature,
                        imageAlt: 'ลายเซ็น',
                        confirmButtonText: 'ปิด'
                    });
                } else {
                    Swal.fire({
                        icon: 'info',
                        title: 'ไม่มีลายเซ็น',
                        text: 'เอกสารนี้ยังไม่ถูกลงนามรับทราบ',
                        confirmButtonText: 'ตกลง'
                    });
                }
            } catch (error) {
                console.error('Show signature view error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: `ไม่สามารถโหลดลายเซ็นได้: ${error.message}`,
                    confirmButtonText: 'ตกลง'
                });
            }
        }

        function initSearchAndFilter() {
            const searchInput = document.getElementById('search-input');
            const filterActivity = document.getElementById('filter-activity');
            searchInput.addEventListener('input', () => fetchAllData(filterActivity.value, searchInput.value));
            filterActivity.addEventListener('change', () => fetchAllData(filterActivity.value, searchInput.value));
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function getStatusBadge(status, signature) {
            const color = status === 'รับทราบแล้ว' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
            return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${color}">${status}</span>`;
        }
    </script>
</body>
</html>
